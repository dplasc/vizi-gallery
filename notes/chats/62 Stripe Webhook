U redu. Evo **STRUCTURED SUMMARY / HANDOFF** za ovaj chat, toÄno po traÅ¾enom formatu i bez preskakanja.

---

## 1. Chat broj

**Chat #62**

---

## 2. Naslov chata

**Stripe Webhook (Test mode) â€“ Signature verification, middleware exclusion i delivery recovery**

---

## 3. Faza projekta

**FAZA 61 â€“ Stripe PRO pretplate (backend integracija & webhook stabilizacija)**

---

## 4. Å to smo konkretno napravili / zakljuÄili

* Resetirali Stripe **TEST MODE** webhook setup (krenuli ispoÄetka).
* Obrisali / disableali stare i krive webhook destinacije (formulaguard.com).
* Kreirali **novi test webhook**:

  * `https://www.vizi.hr/api/stripe/webhook`
  * sluÅ¡a samo:

    * `checkout.session.completed`
    * `customer.subscription.updated`
    * `customer.subscription.deleted`
* ViÅ¡e puta rijeÅ¡avali **INVALID_SIGNATURE** problem:

  * usklaÄ‘en `www.vizi.hr` kao primary domain (bez 307 redirecta)
  * osigurano Äitanje **raw body** (`arrayBuffer â†’ Buffer`)
  * case-insensitive Äitanje `Stripe-Signature` headera
  * izuzet `/api/stripe/webhook` iz **Next.js middlewarea**
* Otkriven stvarni uzrok:

  * `STRIPE_WEBHOOK_SECRET` u Vercelu je imao **nevidljiv whitespace / newline**
* Implementiran **finalni fix**:

  * `process.env.STRIPE_WEBHOOK_SECRET?.trim()` u webhook ruti
* Commitano i deployano:

  * `fix: trim STRIPE_WEBHOOK_SECRET to prevent signature mismatch`
* Stripe webhook **delivery sada prolazi**:

  * `checkout.session.completed` â†’ **200 OK**
  * `customer.subscription.updated` â†’ **200 OK**

---

## 5. Å to je IZRIÄŒITO odluÄeno / zakljuÄano

* Stripe webhook **mora uvijek biti izuzet iz middlewarea**.
* Webhook **mora koristiti raw body + Buffer**, nikad `req.json()`.
* `STRIPE_WEBHOOK_SECRET` se **uvijek trimma** u kodu.
* Test mode se **mora 100% zavrÅ¡iti** prije prelaska na live.
* Ne radimo viÅ¡e â€œresend starih eventaâ€ za debug â€“ samo **novi eventi**.

---

## 6. Otvorene stavke

* âŒ **I dalje se NE upisuje red u `public.subscriptions`**, iako:

  * Stripe eventi dolaze
  * webhook vraÄ‡a 200
  * `metadata.user_id` postoji u eventu
* Treba provjeriti **logiku upisa u Supabase**:

  * koji event toÄno radi `upsert`
  * da li se `subscription` objekt pravilno dohvaÄ‡a
  * da li `service role` klijent i tablica rade bez RLS blokade
* MoguÄ‡i problem:

  * upsert se ne izvrÅ¡ava jer je fallback logika previÅ¡e â€œtolerantnaâ€
  * ili se `stripe_subscription_id` ne poklapa s conflict kljuÄem

---

## 7. SljedeÄ‡i dogovoreni korak (samo jedan)

ğŸ‘‰ **U novom chatu: izolirati i debugirati SAMO Supabase upsert logiku u webhooku**
(konkretnim `console.log` / privremenim return payloadom da vidimo je li upsert ikad pozvan).

---

## 8. Napomena za nastavak u novom chatu

* Novi chat zapoÄeti s ovom reÄenicom:
  **â€œNastavljamo Chat #62 â€“ Stripe webhook radi (200 OK), ali nema upisa u `subscriptions`.â€**
* Ne diramo Stripe viÅ¡e.
* Fokus je **iskljuÄivo backend Supabase insert/upsert**.
* Radimo opet **1 korak po poruci**.

---

Spreman sam. Kad otvoriÅ¡ novi chat i zalijepiÅ¡ ovu napomenu, odmah nastavljamo tamo gdje smo stali.
