**STRUCTURED SUMMARY / HANDOFF**

---

### 1. Chat broj

**Chat #8**

---

### 2. Naslov chata

**Vizi.hr — Onboarding flow stabilizacija + public profile read (RLS/view bug)**

---

### 3. Faza projekta

**FAZA 4 — Onboarding flow (username setup) + public profile dostupnost**

---

### 4. Što smo konkretno napravili / zaključili

* Implementiran i iterativno stabiliziran **obavezni onboarding flow**:

  * `/onboarding` je obavezan nakon login/signup
  * onboarding **uvijek prikazuje formu**, bez auto-redirecta
* Popravljen **auth redirect flow**:

  * svi auth callbackovi (login, signup, magic link, OAuth) **uvijek vode na `/onboarding`**
  * ignoriran `redirect_to` parametar
* Uklonjeni svi **hard crash** slučajevi:

  * uklonjeni `throw new Error("Failed to load profile")`
  * zamijenjeno s `notFound()` i graceful handling
* Stabiliziran **bootstrapProfile**:

  * uklonjen `throw` na select greškama
  * omogućeno sigurno insert/update ponašanje
* Učinjena **STRICT provjera spremanja username-a**:

  * `upsertProfileUsername` vraća `ok:true` **samo ako je username stvarno spremljen**
  * dodan error `SAVE_FAILED`
  * verifikacija koristi `.maybeSingle()`
* Onboarding forma redirecta **isključivo kad server action vrati ok:true**
* Identificiran i popravljen **public profile API bug**:

  * public API je krivo čitao iz `profiles`
  * prebačeno na `public_profiles` view
* Utvrđeno da u **produkcijskoj Supabase bazi**:

  * API endpoint vraća `{ ok:false, error:"Internal error" }`
  * najvjerojatniji uzrok: **nepostojanje `public_profiles` view-a ili GRANT-a u produkciji**

---

### 5. Što je IZRIČITO odlučeno (zaključano)

* Onboarding je **obavezan** i ne smije se preskakati
* `/onboarding` **nikad** ne redirecta automatski na `/{username}`
* Redirect na `/{username}` događa se **samo nakon uspješnog submita**
* Public čitanje profila ide **isključivo preko `public_profiles` view-a**
* `profiles` tablica **nema public SELECT**
* Nema dodavanja novih tablica, CMS-a ni featurea u FAZI 4

---

### 6. Otvorene stavke

* **Supabase produkcija**:

  * potrebno je potvrditi da `public_profiles` view postoji
  * i da `anon` / `authenticated` imaju `SELECT` prava
* Dok se to ne riješi:

  * public API vraća `{ ok:false, error:"Internal error" }`
  * `/[username]` prikazuje “Profil nije pronađen”

---

### 7. Sljedeći dogovoreni korak (jedan)

* **U Supabase SQL Editoru izvršiti SQL za `public_profiles` view + GRANT SELECT**, zatim ponovno testirati public API endpoint.

---

### 8. Napomena za nastavak u novom chatu

* Novi chat započeti s kontekstom: **FAZA 4 — finalni fix public read (Supabase view/RLS)**.
* Prvi korak u novom chatu: potvrditi stanje `public_profiles` view-a u produkciji i validirati `/api/public/profiles/by-username/:username`.
